---
title: "MSD Questions & Answers"
author: "T. Essam & A. Chafetz | SI"
date: "2024-09-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE
  )
# general
library(tidyverse)
library(glue)
# oha
library(gagglr)
library(scales, warn.conflicts = FALSE)
library(systemfonts)
library(tidytext)
library(patchwork)
library(ggtext)
library(gt)
library(gtExtras)
library(gtayblr) # Optional
```

## MSD Questions

Welcome to the SI MSD Sample Analytic Questions exercise. Below, you will find solutions to each question.

```{r grab data}
library(piggyback)

  piggyback::pb_download("MER_Structured_TRAINING_Datasets_PSNU_IM_FY59-62_20240816_v1_1.zip",
    repo = "USAID-OHA-SI/themask",
    tag = "latest",
    dest = "Data"
  )

```

Now, let's use some of the existing SI infrastructure to make loading and working with the data easier.

```{r data handling}

  # Return the most recent version of the PSNU_IM file
  path_msd <- return_latest("Data", pattern = "PSNU_IM")
  
  ref_id <- "0710af56" # a reference to be places in viz captions
  
  # Store metadata in list object for use in plotting and filters
  meta <- get_metadata(path_msd) # extract MSD metadata

  df_msd <- read_psd(path_msd)
  
```

### Q1.Which partner should we focus on with lower target achievement in test positivity for the year?

```{r target achievement}

  # Create a testing data frame to review
  df_hts_ptnr <- df_msd %>%
    filter(
      fiscal_year == meta$curr_fy,
      indicator == "HTS_TST_POS",
      standardizeddisaggregate == "Total Numerator"
    ) %>%
    group_by(prime_partner_name) %>%
    summarize(across(.cols = c(targets, cumulative), \(x) sum(x, na.rm = T)), .groups = "drop") %>%
    calc_achievement() %>% 
    arrange(achievement)
  
  df_hts_ptnr  

```

Let's take a look at the median target levels and use this to lump the partners into high/low volume

```{r volume lumps}
  # What is the median target level?
  tgt_median <- median(df_hts_ptnr$targets, na.rm = T)
  
  df_hts_ptnr <-
    df_hts_ptnr %>%
    mutate(hts_volume = ifelse(targets > tgt_median, "High", "Low")) 
  
  trbl_ptnr <- df_hts_ptnr %>%
    filter(hts_volume == "High", achievement < 0.5) %>%
    pull(prime_partner_name)
```

We can summarize the data by high and low testing volume to see which high volume partners are under-performing.

```{r partner table}
  df_hts_ptnr %>%
    gt(groupname_col = "hts_volume") %>%
    sub_missing(missing_text = "-") %>%
    fmt_percent(columns = achievement, decimal = 0) %>%
    fmt_number(columns = c(targets, cumulative), decimal = 0) %>% 
    gt_highlight_rows(rows = prime_partner_name == "Dash", fill = grey20k) %>%
    gtayblr::si_gt_base() %>%
    tab_header(title = glue("{trbl_ptnr} lags behind in performance")) %>%
    tab_source_note(source_note = glue("{meta$caption}"))
```

The prime partner with a high volume of targets but low achievement was `r df_hts_ptnr %>% filter(hts_volume == "High", achievement < 0.5) %>% select(prime_partner_name)`

### Q2. What share of total and positive tests are from index testing in the latest quarter?

For this question, we'll want to use the testing modality column to extract index testing results. Because we have been asked to calculate a share, we'll also want to extract testing totals for `HTS_TST` and `HTS_TST_POS`.

```{r}
  # What is the last quarter?
  meta$curr_qtr
  
  # Indicator list
  indic_list <- c("HTS_TST_POS", "HTS_TST")
  
  # What are total test results?
  df_index_tot <- df_msd %>%
    filter(
      indicator %in% indic_list,
      fiscal_year == meta$curr_fy,
      standardizeddisaggregate == "Total Numerator"
    ) %>%
    count(indicator, wt = qtr3) %>%
    rename(total = n)
  
  df_index_tot
```

Now that we have the totals in separate object, we can create the index-specific totals using the `Modality/Age/Sex/Result` standardized disaggregate along with any modalities that contain the word `Index`.

```{r}
  df_index <- df_msd %>%
    filter(
      indicator %in% indic_list,
      standardizeddisaggregate == "Modality/Age/Sex/Result",
      str_detect(modality, "Index")
    ) %>%
    group_by(indicator, fiscal_year) %>%
    summarize(across(.cols = contains("qtr"), \(x) sum(x, na.rm = T)), .groups = "drop") %>%
    reshape_msd() %>%
    filter(period == meta$curr_pd) %>%
    left_join(df_index_tot) %>%
    mutate(share = value / total)
  
  df_index

```

If we wanted to clean up the data frame and present it as a table the `gt` package is our friend.

```{r}
  
  df_index %>% 
    gt(groupname_col = "period") %>%
    cols_hide(period_type) %>%
    fmt_percent(columns = share, decimal = 0) %>%
    fmt_number(columns = value:total, decimals = 0) %>%
    cols_label(value = "index testing results") %>%
    si_gt_base() %>%
    tab_header(title = "Index testing results summary") %>%
    tab_source_note(source_note = glue("{meta$caption}"))
```

### Q3. Which sub-national units (SNUs) have seen a decline in testing over the last few quarters, but an increase in positivity.

To answer this question we are going to need to group the data by SNU and periods. We will also need to extract totals for `HTS_TST` and `HST_TST_POS` to calculate positivity, which is defined as: $positivity = \frac{\text{hts_tst_pos}}{\text{hts_tst}}$. Once we have positivity and testing volumes calculated, we can use a window function on each snu1

```{r}
  df_hts_snu1 <- df_msd %>%
    filter(
      indicator %in% indic_list,
      standardizeddisaggregate == "Total Numerator"
    ) %>%
    group_by(snu1, fiscal_year, indicator) %>%
    summarize(across(.cols = contains("qtr"), \(x) sum(x, na.rm = T)), .groups = "drop") %>%
    reshape_msd() %>%
    select(-period_type) %>%
    pivot_wider(
      names_from = indicator,
      values_from = value
    ) %>%
    mutate(positivity = HTS_TST_POS / HTS_TST) %>%
    group_by(snu1) %>%
    arrange(period) %>%
    mutate(
      HTS_TST_trend = (HTS_TST - lag(HTS_TST)) / lag(HTS_TST),
      pos_trend = (positivity - lag(positivity)) / lag(positivity)
    ) %>%
    ungroup() %>%
    mutate(
            HTS_TST_trend = ifelse(is.na(HTS_TST_trend) | lag(HTS_TST) == 0, NA, HTS_TST_trend),
      pos_trend = ifelse(is.na(pos_trend) | lag(positivity) == 0, NA, pos_trend),
      flag_up_down = (HTS_TST_trend < 0 & pos_trend > 0),
      flag_down_up = (HTS_TST_trend > 0 & pos_trend < 0)
    )
  
  df_hts_snu1 %>% arrange(snu1)
```

We can use a wide table to see the patterns of positivity and testing results.

```{r}
  # Any decline in testing but increase in positivity?
  # Two SNUs had a decline in testing but increase in positivity
  df_hts_snu1 %>%
    filter(period > "FY60Q1") %>%
    count(snu1, period, flag_up_down) %>% 
    spread(period, n) %>% arrange(desc(flag_up_down))
  
  # df_hts_snu1 %>%
  #   filter(period > "FY59Q1") %>%
  #   count(snu1, flag_down_up, sort = T) %>%
  #   pivot_wider(names_from = flag_down_up, values_from = n)
```

We can also visualize the results with a bar graph.

```{r message=FALSE, warning=FALSE, out.width = '85%'}

  # Label the periods on the graph
  period_labels <- df_hts_snu1 %>%
    distinct(period) %>%
    pull()
  
 period_custom_labels <- ifelse(grepl("Q1", period_labels) | 
                                  period_labels == tail(period_labels, 1), 
                                period_labels, "")

  # Explore data
  df_hts_snu1 %>%
    ggplot(aes(x = period)) +
    geom_col(aes(y = HTS_TST), fill = hw_hunter, width = 0.5) +
    geom_col(aes(y = HTS_TST_POS),
      fill = tango, width = 0.5,
      position = position_nudge(x = 0.1)
    ) +
    geom_label(aes(label = percent(positivity, accuracy = 0.01), y = HTS_TST_POS),
      size = 7/.pt,
      family = "Source Sans Pro",
      color = grey90k,
      nudge_x = 0.1,
      vjust = -1
    ) +
    facet_wrap(~snu1, scale = "free_y") +
    scale_y_continuous(labels = comma) +
    scale_x_discrete(labels = period_custom_labels) +
    si_style_ygrid(facet_space = 0.5) +
    labs(
      title = "HTS_TST COMPARED TO HTS_TST_POS RESULTS ACROSS SNU1S",
      subtitle = "Midwest and Northwest have declining test volumne and increasing positivity",
      caption = glue("{meta$caption}")
    )
```

### Q4. What share of newly initiated patients onto treatment have a CD4 count of less than 200?

For this question, we are going to assume newly initiated patients includes all TX_NEW through Q3 in the most recent fiscal year. You could also calculate this just for Q3.

```{r}
  # How many clients on TX_NEW in the most recent fiscal year?
  df_tx_new <- df_msd %>%
    filter(
      indicator == "TX_NEW",
      standardizeddisaggregate == "Total Numerator",
      fiscal_year == meta$curr_fy
    ) %>%
    count(indicator, wt = cumulative, name = "tot_tx_new")
  df_tx_new
```

And of those TX_NEW, how many have reported CD4 counts less than 200?

```{r}
  # Not all facilities report CD4 data so disag may not total up
  df_msd %>%
    filter(
      indicator == "TX_NEW",
      standardizeddisaggregate == "Age/Sex/CD4/HIVStatus",
      fiscal_year == meta$curr_fy
    ) %>%
    group_by(indicator, otherdisaggregate) %>%
    summarise(cd4_totals = sum(cumulative, na.rm = T)) %>%
    left_join(df_tx_new) %>%
    mutate(share = cd4_totals / tot_tx_new) %>%
    gt() %>%
    fmt_number(columns = where(is.double), decimals = 0) %>%
    fmt_percent(columns = share) %>%
    si_gt_base() %>%
    tab_header(title = "Small share of cd4 clients below 200") %>%
    tab_source_note(source_note = glue("{meta$caption}"))
```

### Q5. Which age bands have had two or more quarters with declining net new on treatment?

To answer this question we'll need to grab the TX_NET_NEW disaggregates for the different age bands.

```{r}
  df_tx_nn <- df_msd %>%
    filter(
      indicator == "TX_NET_NEW",
      use_for_age == "Y",
      age_2019 != "Unknown Age"
    ) %>%
    rename(age = age_2019) %>% 
    group_by(indicator, age, fiscal_year) %>%
    summarize(across(.cols = contains("qtr"), \(x) sum(x, na.rm = T)), .groups = "drop") %>%
    reshape_msd() %>%
    group_by(age) %>%
    mutate(
      tx_nn_decline = value < 0,
      tx_nn_count = sum(tx_nn_decline)
    ) %>%
    ungroup()
  df_tx_nn
```

We could tabulate the results, but sometimes a plot is a better way to highlight deviations from a benchmark, in this case that benchmark is 0 net new.

```{r net new plot, }
  # Label the periods on the graph
  period_labels <- df_tx_nn %>%
    distinct(period) %>%
    pull()
  period_custom_labels <- ifelse(grepl("Q1", period_labels) | period_labels == tail(period_labels, 1),
    period_labels, ""
  )
  
  # Summary plot
  df_tx_nn %>%
    ggplot(aes(x = period, y = value)) +
    geom_col(aes(fill = ifelse(value < 0, hw_orchid_bloom, hunter))) +
    facet_wrap(~ glue::glue("Ages {age}: {tx_nn_count} total quarters with declines"),
      scales = "free_y",
      labeller = label_wrap_gen(30)
    ) +
    scale_fill_identity() +
    si_style_ygrid(facet_space = 0.5, text_scale = 0.6) +
    labs(
      title = "AGES 45 AND ABOVE LOGGED FEWER THAN TWO QUARTERS OF TREATMENT LOSS",
      x = NULL, y = "TX_NET_NEW",
      caption = glue("{meta$caption}")
    ) +
    scale_x_discrete(labels = period_custom_labels)
```

### Q6. Which sub-national units (SNUs) had net new on treatment volumes below those newly on treatment for the year?

```{r}
  df_nn_snu <- df_msd %>%
    filter(
      indicator %in% c("TX_NEW", "TX_NET_NEW"),
      fiscal_year == meta$curr_fy,
      standardizeddisaggregate == "Total Numerator"
    ) %>%
    group_by(snu1, indicator) %>%
    summarize(total = sum(cumulative, na.rm = T), .groups = "drop") %>%
    spread(indicator, total) %>%
    mutate(nn_below_tx_new = TX_NET_NEW < TX_NEW) 
  
  df_nn_snu %>% 
    gt() %>%
    fmt_number(columns = where(is.double), decimals = 0) %>%
    si_gt_base() %>%
    tab_header(title = "Treatment volume summary by snu1") %>%
    tab_source_note(source_note = glue("{meta$caption}"))
```

`r df_nn_snu %>% filter(nn_below_tx_new == T) %>% pull(snu1)` all had net new treatment volumes below newly on treatment for the year.

### Q7. Are any sub-national units (SNUs) lagging behind in getting a majority of patients onto 6-month or more multi-month dispensing (MMD) of treatment. 

### Q8. Do we see any differences in viral load coverage (VLC) by age and sex for the current year?

```{r}
# Review the indicators needed
  df_msd %>%
    filter(indicator %in% c("TX_PVLS", "TX_CURR"),
           use_for_age == "Y") %>%
    count(standardizeddisaggregate, numeratordenom, indicator, use_for_age, wt = cumulative) %>%
    arrange(numeratordenom, indicator)
  
```

```{r}
# Calculate VLC data frame
  df_vlc <- df_msd %>%
    filter(
      age_2019 %ni% c("Unknown Age", "Newer Age Band"),
      indicator %in% c("TX_CURR_Lag2", "TX_PVLS"),
      standardizeddisaggregate %in% c(
        "Age/Sex/HIVStatus",
        "Age/Sex/Indication/HIVStatus"
      ),
      use_for_age == "Y"
    ) %>%
    gophr::clean_indicator() %>% # Affixes an N or D to TX_PVLS stub
    group_by(indicator, fiscal_year, sex, age_2019) %>%
    summarise(across(starts_with("qtr"), \(x) sum(x, na.rm = TRUE)),
      .groups = "drop"
    ) %>%
    reshape_msd(include_type = FALSE) %>%
    pivot_wider(
      names_from = indicator,
      names_glue = "{tolower(indicator)}"
    ) %>%
    mutate(
      vlc = tx_pvls_d / tx_curr_lag2,
      vls = tx_pvls / tx_pvls_d,
      sex_color = ifelse(sex == "Female", hw_lavender_haze, hw_hunter)
    )
```
